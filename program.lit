
=tokenize
-def tokenize(t):
-	return t.split('##')

=generate
-def generate(tokens):
-	code=["def template(data):"]
-	indent="    "
-	stack=[]
-	shadows=[]

-	def getvalue(x):
-		for v,r in shadows:
-			if v==x: x=r
-		return 'getvalue(%s)'%(repr(x),)

-	for i in range(len(tokens)):
-		token=tokens[i]
-		if i%2:
-			print stack
-			if token.endswith('?'):
-				code.append("%selif compare(%s,%s):"%(indent[:-4],repr(token[:-1]),getvalue(stack[-1][1])))
-			elif '>' in token:
-				var,block=token.split('>')
-				shadows.insert(0,(var,))
-				code.append("%sblock_%s(%s)"%(indent,block,getvalue(var)))
-			elif '&' in token:
-				var,lst=token.split('&')
-				code.append("%sfor %s in %s:"%(indent,var,lst))
-				indent+='    '
-				stack.append(['for'])
-			elif '=' in token:
-				var,name=token.split('=')
-				code.append("%sdef block_%s(value):"%(indent,name))
-				indent+='    '
-			elif '?' in token:
-				value,var=token.split('?')
-				code.append("%sif compare(%s,%s):"%(indent,repr(value),getvalue(var)))
-				indent+='    '
-				stack.append(['if',var])
-			elif token=='*':
-				code.append("%selse:"%(indent[:-4],))
-			elif token=='':
-				if stack[-1][0]=='block':
-					var=stack[-1][1]
-					shadows.pop(0)
-				if stack[-1][0]!='choice':
-					indent=indent[:-4]
-				stack.pop()
-			else:
-				code.append("%soutput(%s)"%(indent,getvalue(token)))
-		else:
-			if token!='':
-				code.append("%soutput(%s)"%(indent,repr(token)))
-	return '\n'.join(code)

=compile
-def compile(source):
-	l={}
-	exec(source,{},l)
-	return l['template']

=>beard.py
>tokenize
>generate
>compile

-test="""
>example
-"""

-tokens=tokenize(test)
-template=generate(tokens)
-print template
-ctemplate=compile(template)
-print ctemplate
-print dir(ctemplate)

=example
-<html>
-<head>
-	<title>Hello, world</title>
-</head>
-<body>
-	<div>Simple variable substition ##simple_var##</div>
-
-	<div>
-		Simple boolean conditional
-		##true?cond_var##
-			<div>Yes</div>
-		####
-		##false?cond_var##
-			<div>no</div>
-		####
-	</div>
-
-	##cond_var=block##
-	<div>
-		Choice conditional
-		##left?cond_var##
-			<div style="text-align:left">Stay at Left</div>
-		##center?##
-			<div> style="text-align:center">Hold Center</div>
-		##right?##
-			<div> style="text-align:center">Lean to Right</div>
-		##*##
-			<div> style="text-align:center">Dunno what to do with ##cond_var##</div>
-		####
-	</div>
-	####
-
-	<div>
-		Iteration
-		##i&list_var##
-			##i>block##
-		####
-	</div>
-
-</body>
-</html>
